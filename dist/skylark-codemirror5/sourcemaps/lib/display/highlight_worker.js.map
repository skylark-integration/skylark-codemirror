{"version":3,"sources":["lib/display/highlight_worker.js"],"names":["define","a","b","c","d","e","startWorker","cm","time","doc","highlightFrontier","display","viewTo","state","highlight","set","bind","highlightWorker","end","Date","options","workTime","context","getContextBefore","changedLines","iter","line","Math","min","first","size","viewFrom","oldStyles","styles","resetState","text","length","maxHighlightLength","copyState","mode","highlighted","highlightLine","oldCls","styleClasses","newCls","classes","ischange","bgClass","textClass","i","push","stateAfter","save","nextLine","processLine","workDelay","modeFrontier","max","runInOp","regLineChange"],"mappings":";;;;;;;AAAAA,QACI,oBACA,WACA,eACA,eACA,mBACD,SAAUC,EAAGC,EAAGC,EAAGC,EAAGC,GACrB,aACA,SAASC,EAAYC,EAAIC,GACjBD,EAAGE,IAAIC,kBAAoBH,EAAGI,QAAQC,QACtCL,EAAGM,MAAMC,UAAUC,IAAIP,EAAML,EAAEa,KAAKC,EAAiBV,IAE7D,SAASU,EAAgBV,GACrB,IAAIE,EAAMF,EAAGE,IACb,GAAIA,EAAIC,mBAAqBH,EAAGI,QAAQC,OACpC,OACJ,IAAIM,GAAO,IAAIC,KAASZ,EAAGa,QAAQC,SAC/BC,EAAUrB,EAAEsB,iBAAiBhB,EAAIE,EAAIC,mBACrCc,KACJf,EAAIgB,KAAKH,EAAQI,KAAMC,KAAKC,IAAInB,EAAIoB,MAAQpB,EAAIqB,KAAMvB,EAAGI,QAAQC,OAAS,KAAMc,IAC5E,GAAIJ,EAAQI,MAAQnB,EAAGI,QAAQoB,SAAU,CACrC,IAAIC,EAAYN,EAAKO,OACjBC,EAAaR,EAAKS,KAAKC,OAAS7B,EAAGa,QAAQiB,mBAAqBnC,EAAEoC,UAAU7B,EAAI8B,KAAMjB,EAAQT,OAAS,KACvG2B,EAAcvC,EAAEwC,cAAclC,EAAImB,EAAMJ,GAAS,GACjDY,IACAZ,EAAQT,MAAQqB,GACpBR,EAAKO,OAASO,EAAYP,OAC1B,IAAIS,EAAShB,EAAKiB,aAAcC,EAASJ,EAAYK,QACjDD,EACAlB,EAAKiB,aAAeC,EACfF,IACLhB,EAAKiB,aAAe,MACxB,IAAIG,GAAYd,GAAaA,EAAUI,QAAUV,EAAKO,OAAOG,QAAUM,GAAUE,KAAYF,IAAWE,GAAUF,EAAOK,SAAWH,EAAOG,SAAWL,EAAOM,WAAaJ,EAAOI,WACjL,IAAK,IAAIC,EAAI,GAAIH,GAAYG,EAAIjB,EAAUI,SAAUa,EACjDH,EAAWd,EAAUiB,IAAMvB,EAAKO,OAAOgB,GACvCH,GACAtB,EAAa0B,KAAK5B,EAAQI,MAC9BA,EAAKyB,WAAa7B,EAAQ8B,OAC1B9B,EAAQ+B,gBAEJ3B,EAAKS,KAAKC,QAAU7B,EAAGa,QAAQiB,oBAC/BpC,EAAEqD,YAAY/C,EAAImB,EAAKS,KAAMb,GACjCI,EAAKyB,WAAa7B,EAAQI,KAAO,GAAK,EAAIJ,EAAQ8B,OAAS,KAC3D9B,EAAQ+B,WAEZ,IAAK,IAAIlC,KAASD,EAEd,OADAZ,EAAYC,EAAIA,EAAGa,QAAQmC,YACpB,IAGf9C,EAAIC,kBAAoBY,EAAQI,KAChCjB,EAAI+C,aAAe7B,KAAK8B,IAAIhD,EAAI+C,aAAclC,EAAQI,MAClDF,EAAaY,QACbhC,EAAEsD,QAAQnD,EAAI,KACV,IAAK,IAAI0C,EAAI,EAAGA,EAAIzB,EAAaY,OAAQa,IACrC5C,EAAEsD,cAAcpD,EAAIiB,EAAayB,GAAI,UAGrD,OAAS3C,YAAaA","file":"../../../lib/display/highlight_worker.js","sourcesContent":["define([\n    '../line/highlight',\n    '../modes',\n    '../util/misc',\n    './operations',\n    './view_tracking'\n], function (a, b, c, d, e) {\n    'use strict';\n    function startWorker(cm, time) {\n        if (cm.doc.highlightFrontier < cm.display.viewTo)\n            cm.state.highlight.set(time, c.bind(highlightWorker, cm));\n    }\n    function highlightWorker(cm) {\n        let doc = cm.doc;\n        if (doc.highlightFrontier >= cm.display.viewTo)\n            return;\n        let end = +new Date() + cm.options.workTime;\n        let context = a.getContextBefore(cm, doc.highlightFrontier);\n        let changedLines = [];\n        doc.iter(context.line, Math.min(doc.first + doc.size, cm.display.viewTo + 500), line => {\n            if (context.line >= cm.display.viewFrom) {\n                let oldStyles = line.styles;\n                let resetState = line.text.length > cm.options.maxHighlightLength ? b.copyState(doc.mode, context.state) : null;\n                let highlighted = a.highlightLine(cm, line, context, true);\n                if (resetState)\n                    context.state = resetState;\n                line.styles = highlighted.styles;\n                let oldCls = line.styleClasses, newCls = highlighted.classes;\n                if (newCls)\n                    line.styleClasses = newCls;\n                else if (oldCls)\n                    line.styleClasses = null;\n                let ischange = !oldStyles || oldStyles.length != line.styles.length || oldCls != newCls && (!oldCls || !newCls || oldCls.bgClass != newCls.bgClass || oldCls.textClass != newCls.textClass);\n                for (let i = 0; !ischange && i < oldStyles.length; ++i)\n                    ischange = oldStyles[i] != line.styles[i];\n                if (ischange)\n                    changedLines.push(context.line);\n                line.stateAfter = context.save();\n                context.nextLine();\n            } else {\n                if (line.text.length <= cm.options.maxHighlightLength)\n                    a.processLine(cm, line.text, context);\n                line.stateAfter = context.line % 5 == 0 ? context.save() : null;\n                context.nextLine();\n            }\n            if (+new Date() > end) {\n                startWorker(cm, cm.options.workDelay);\n                return true;\n            }\n        });\n        doc.highlightFrontier = context.line;\n        doc.modeFrontier = Math.max(doc.modeFrontier, context.line);\n        if (changedLines.length)\n            d.runInOp(cm, () => {\n                for (let i = 0; i < changedLines.length; i++)\n                    e.regLineChange(cm, changedLines[i], 'text');\n            });\n    }\n    return { startWorker: startWorker };\n});"]}