{"version":3,"sources":["primitives/edit/key_events.js"],"names":["define","a","b","c","d","e","f","g","h","i","j","doHandleBinding","cm","bound","dropShift","commands","display","input","ensurePolled","prevShift","shift","done","isReadOnly","state","suppressEdits","Pass","stopSeq","Delayed","dispatchKey","name","handle","seq","keySeq","isModifierKey","test","set","reset","dispatchKeyInner","result","keyMaps","length","lookupKey","options","extraKeys","keyMap","lookupKeyForEditor","signalLater","e_preventDefault","restartBlink","handleKeyBinding","keyName","shiftKey","motion","lastStoppedKey","onKeyDown","this","curOp","focus","activeElt","signalDOMEvent","ie","ie_version","keyCode","returnValue","code","handled","presto","hasCopyEvent","mac","metaKey","ctrlKey","replaceSelection","lineDiv","className","up","altKey","rmClass","off","document","addClass","on","showCrossHair","onKeyUp","doc","sel","onKeyPress","eventInWidget","charCode","which","ch","String","fromCharCode","handleCharBinding"],"mappings":"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","file":"../../../primitives/edit/key_events.js","sourcesContent":["define([\n    '../util/operation_group',\n    '../display/selection',\n    '../input/keymap',\n    '../measurement/widgets',\n    '../util/browser',\n    '../util/dom',\n    '../util/event',\n    '../util/feature_detection',\n    '../util/misc',\n    './commands'\n], function (a, b, c, d, e, f, g, h, i, j) {\n    'use strict';\n    function doHandleBinding(cm, bound, dropShift) {\n        if (typeof bound == 'string') {\n            bound = j.commands[bound];\n            if (!bound)\n                return false;\n        }\n        cm.display.input.ensurePolled();\n        let prevShift = cm.display.shift, done = false;\n        try {\n            if (cm.isReadOnly())\n                cm.state.suppressEdits = true;\n            if (dropShift)\n                cm.display.shift = false;\n            done = bound(cm) != i.Pass;\n        } finally {\n            cm.display.shift = prevShift;\n            cm.state.suppressEdits = false;\n        }\n        return done;\n    }\n    function lookupKeyForEditor(cm, name, handle) {\n        for (let i = 0; i < cm.state.keyMaps.length; i++) {\n            let result = c.lookupKey(name, cm.state.keyMaps[i], handle, cm);\n            if (result)\n                return result;\n        }\n        return cm.options.extraKeys && c.lookupKey(name, cm.options.extraKeys, handle, cm) || c.lookupKey(name, cm.options.keyMap, handle, cm);\n    }\n    let stopSeq = new i.Delayed();\n    function dispatchKey(cm, name, e, handle) {\n        let seq = cm.state.keySeq;\n        if (seq) {\n            if (c.isModifierKey(name))\n                return 'handled';\n            if (/\\'$/.test(name))\n                cm.state.keySeq = null;\n            else\n                stopSeq.set(50, () => {\n                    if (cm.state.keySeq == seq) {\n                        cm.state.keySeq = null;\n                        cm.display.input.reset();\n                    }\n                });\n            if (dispatchKeyInner(cm, seq + ' ' + name, e, handle))\n                return true;\n        }\n        return dispatchKeyInner(cm, name, e, handle);\n    }\n    function dispatchKeyInner(cm, name, e, handle) {\n        let result = lookupKeyForEditor(cm, name, handle);\n        if (result == 'multi')\n            cm.state.keySeq = name;\n        if (result == 'handled')\n            a.signalLater(cm, 'keyHandled', cm, name, e);\n        if (result == 'handled' || result == 'multi') {\n            g.e_preventDefault(e);\n            b.restartBlink(cm);\n        }\n        return !!result;\n    }\n    function handleKeyBinding(cm, e) {\n        let name = c.keyName(e, true);\n        if (!name)\n            return false;\n        if (e.shiftKey && !cm.state.keySeq) {\n            return dispatchKey(cm, 'Shift-' + name, e, b => doHandleBinding(cm, b, true)) || dispatchKey(cm, name, e, b => {\n                if (typeof b == 'string' ? /^go[A-Z]/.test(b) : b.motion)\n                    return doHandleBinding(cm, b);\n            });\n        } else {\n            return dispatchKey(cm, name, e, b => doHandleBinding(cm, b));\n        }\n    }\n    function handleCharBinding(cm, e, ch) {\n        return dispatchKey(cm, \"'\" + ch + \"'\", e, b => doHandleBinding(cm, b, true));\n    }\n    let lastStoppedKey = null;\n    function onKeyDown(e) {\n        let cm = this;\n        cm.curOp.focus = f.activeElt();\n        if (g.signalDOMEvent(cm, e))\n            return;\n        if (e.ie && e.ie_version < 11 && e.keyCode == 27)\n            e.returnValue = false;\n        let code = e.keyCode;\n        cm.display.shift = code == 16 || e.shiftKey;\n        let handled = handleKeyBinding(cm, e);\n        if (e.presto) {\n            lastStoppedKey = handled ? code : null;\n            if (!handled && code == 88 && !h.hasCopyEvent && (e.mac ? e.metaKey : e.ctrlKey))\n                cm.replaceSelection('', null, 'cut');\n        }\n        if (code == 18 && !/\\bCodeMirror-crosshair\\b/.test(cm.display.lineDiv.className))\n            showCrossHair(cm);\n    }\n    function showCrossHair(cm) {\n        let lineDiv = cm.display.lineDiv;\n        f.addClass(lineDiv, 'CodeMirror-crosshair');\n        function up(e) {\n            if (e.keyCode == 18 || !e.altKey) {\n                f.rmClass(lineDiv, 'CodeMirror-crosshair');\n                g.off(document, 'keyup', up);\n                g.off(document, 'mouseover', up);\n            }\n        }\n        g.on(document, 'keyup', up);\n        g.on(document, 'mouseover', up);\n    }\n    function onKeyUp(e) {\n        if (e.keyCode == 16)\n            this.doc.sel.shift = false;\n        g.signalDOMEvent(this, e);\n    }\n    function onKeyPress(e) {\n        let cm = this;\n        if (d.eventInWidget(cm.display, e) || g.signalDOMEvent(cm, e) || e.ctrlKey && !e.altKey || e.mac && e.metaKey)\n            return;\n        let keyCode = e.keyCode, charCode = e.charCode;\n        if (e.presto && keyCode == lastStoppedKey) {\n            lastStoppedKey = null;\n            g.e_preventDefault(e);\n            return;\n        }\n        if (e.presto && (!e.which || e.which < 10) && handleKeyBinding(cm, e))\n            return;\n        let ch = String.fromCharCode(charCode == null ? keyCode : charCode);\n        if (ch == '\\b')\n            return;\n        if (handleCharBinding(cm, e, ch))\n            return;\n        cm.display.input.onKeyPress(e);\n    }\n    return {\n        dispatchKey: dispatchKey,\n        onKeyDown: onKeyDown,\n        onKeyUp: onKeyUp,\n        onKeyPress: onKeyPress\n    };\n});"]}