/**
 * skylark-codemirror5 - A version of codemirror 5.17.1  that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror5/
 * @license MIT
 */
define(["../line/line_data","../line/pos","../line/spans","../line/utils_line","../util/bidi","../util/browser","../util/dom","../util/event","../util/feature_detection","../util/misc","../display/update_line","./widgets"],function(e,t,i,n,r,l,o,a,d,s,c,f){"use strict";function u(e){return e.lineSpace.offsetTop}function h(e){if(e.cachedPaddingH)return e.cachedPaddingH;let t=o.removeChildrenAndAdd(e.measure,o.elt("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,n={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(n.left)||isNaN(n.right)||(e.cachedPaddingH=n),n}function g(e){return s.scrollerGap-e.display.nativeBarWidth}function p(e){return e.display.scroller.clientWidth-g(e)-e.display.barWidth}function m(e,t,i){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(let i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(let t=0;t<e.rest.length;t++)if(n.lineNo(e.rest[t])>i)return{map:e.measure.maps[t],cache:e.measure.caches[t],before:!0}}function b(e,t,i,n){return w(e,C(e,t),i,n)}function y(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[k(e,t)];let i=e.display.externalMeasured;return i&&t>=i.lineN&&t<i.lineN+i.size?i:void 0}function C(t,r){let l=n.lineNo(r),a=y(t,l);a&&!a.text?a=null:a&&a.changes&&(c.updateLineForChanges(t,a,l,z(t)),t.curOp.forceUpdate=!0),a||(a=function(t,r){r=i.visualLine(r);let l=n.lineNo(r),a=t.display.externalMeasured=new e.LineView(t.doc,r,l);a.lineN=l;let d=a.built=e.buildLineContent(t,a);return a.text=d.pre,o.removeChildrenAndAdd(t.display.lineMeasure,d.pre),a}(t,r));let d=m(a,r,l);return{line:r,view:a,rect:null,map:d.map,cache:d.cache,before:d.before,hasHeights:!1}}function w(e,t,i,n,r){t.before&&(i=-1);let a,d=i+(n||"");return t.cache.hasOwnProperty(d)?a=t.cache[d]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(!function(e,t,i){let n=e.options.lineWrapping,r=n&&p(e);if(!t.measure.heights||n&&t.measure.width!=r){let e=t.measure.heights=[];if(n){t.measure.width=r;let n=t.text.firstChild.getClientRects();for(let t=0;t<n.length-1;t++){let r=n[t],l=n[t+1];Math.abs(r.bottom-l.bottom)>2&&e.push((r.bottom+l.top)/2-i.top)}}e.push(i.bottom-i.top)}}(e,t.view,t.rect),t.hasHeights=!0),(a=function(e,t,i,n){let r,a=L(t.map,i,n),d=a.node,c=a.start,f=a.end,u=a.collapse;if(3==d.nodeType){for(let e=0;e<4;e++){for(;c&&s.isExtendingChar(t.line.text.charAt(a.coverStart+c));)--c;for(;a.coverStart+f<a.coverEnd&&s.isExtendingChar(t.line.text.charAt(a.coverStart+f));)++f;if((r=l.ie&&l.ie_version<9&&0==c&&f==a.coverEnd-a.coverStart?d.parentNode.getBoundingClientRect():H(o.range(d,c,f).getClientRects(),n)).left||r.right||0==c)break;f=c,c-=1,u="right"}l.ie&&l.ie_version<11&&(r=P(e.display.measure,r))}else{let t;c>0&&(u=n="right"),r=e.options.lineWrapping&&(t=d.getClientRects()).length>1?t["right"==n?t.length-1:0]:d.getBoundingClientRect()}if(l.ie&&l.ie_version<9&&!c&&(!r||!r.left&&!r.right)){let t=d.parentNode.getClientRects()[0];r=t?{left:t.left,right:t.left+_(e.display),top:t.top,bottom:t.bottom}:v}let h=r.top-t.rect.top,g=r.bottom-t.rect.top,p=(h+g)/2,m=t.view.measure.heights,b=0;for(;b<m.length-1&&!(p<m[b]);b++);let y=b?m[b-1]:0,C=m[b],w={left:("right"==u?r.right:r.left)-t.rect.left,right:("left"==u?r.left:r.right)-t.rect.left,top:y,bottom:C};r.left||r.right||(w.bogus=!0);e.options.singleCursorHeightPerLine||(w.rtop=h,w.rbottom=g);return w}(e,t,i,n)).bogus||(t.cache[d]=a)),{left:a.left,right:a.right,top:r?a.rtop:a.top,bottom:r?a.rbottom:a.bottom}}let x,v={left:0,right:0,top:0,bottom:0};function L(e,t,i){let n,r,l,o,a,d;for(let s=0;s<e.length;s+=3)if(a=e[s],d=e[s+1],t<a?(r=0,l=1,o="left"):t<d?l=(r=t-a)+1:(s==e.length-3||t==d&&e[s+3]>t)&&(r=(l=d-a)-1,t>=d&&(o="right")),null!=r){if(n=e[s+2],a==d&&i==(n.insertLeft?"left":"right")&&(o=i),"left"==i&&0==r)for(;s&&e[s-2]==e[s-3]&&e[s-1].insertLeft;)n=e[2+(s-=3)],o="left";if("right"==i&&r==d-a)for(;s<e.length-3&&e[s+3]==e[s+4]&&!e[s+5].insertLeft;)n=e[(s+=3)+2],o="right";break}return{node:n,start:r,end:l,collapse:o,coverStart:a,coverEnd:d}}function H(e,t){let i=v;if("left"==t)for(let t=0;t<e.length&&(i=e[t]).left==i.right;t++);else for(let t=e.length-1;t>=0&&(i=e[t]).left==i.right;t--);return i}function P(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!d.hasBadZoomedRects(e))return t;let i=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*i,right:t.right*i,top:t.top*n,bottom:t.bottom*n}}function W(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(let t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function R(e){e.display.externalMeasure=null,o.removeChildren(e.display.lineMeasure);for(let t=0;t<e.display.view.length;t++)W(e.display.view[t])}function S(){return l.chrome&&l.android?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function A(){return l.chrome&&l.android?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function M(e){let t=0;if(e.widgets)for(let i=0;i<e.widgets.length;++i)e.widgets[i].above&&(t+=f.widgetHeight(e.widgets[i]));return t}function B(e,t,n,r,l){if(!l){let e=M(t);n.top+=e,n.bottom+=e}if("line"==r)return n;r||(r="local");let o=i.heightAtLine(t);if("local"==r?o+=u(e.display):o-=e.display.viewOffset,"page"==r||"window"==r){let t=e.display.lineSpace.getBoundingClientRect();o+=t.top+("window"==r?0:A());let i=t.left+("window"==r?0:S());n.left+=i,n.right+=i}return n.top+=o,n.bottom+=o,n}function N(e,t,i,l,o,a){function d(t,n){let r=w(e,o,t,n?"right":"left",a);return n?r.left=r.right:r.right=r.left,B(e,l,r,i)}l=l||n.getLine(e.doc,t.line),o||(o=C(e,l));let s=r.getOrder(l,e.doc.direction),c=t.ch,f=t.sticky;if(c>=l.text.length?(c=l.text.length,f="before"):c<=0&&(c=0,f="after"),!s)return d("before"==f?c-1:c,"before"==f);function u(e,t,i){let n=1==s[t].level;return d(i?e-1:e,n!=i)}let h=r.getBidiPartAt(s,c,f),g=r.bidiOther,p=u(c,h,"before"==f);return null!=g&&(p.other=u(c,g,"before"!=f)),p}function I(e,i,n,r,l){let o=t.Pos(e,i,n);return o.xRel=l,r&&(o.outside=!0),o}function T(e,t,r){let l=e.doc;if((r+=e.display.viewOffset)<0)return I(l.first,0,null,!0,-1);let o=n.lineAtHeight(l,r),a=l.first+l.size-1;if(o>a)return I(l.first+l.size-1,n.getLine(l,a).text.length,null,!0,1);t<0&&(t=0);let d=n.getLine(l,o);for(;;){let a=E(e,d,o,t,r),s=i.collapsedSpanAround(d,a.ch+(a.xRel>0?1:0));if(!s)return a;let c=s.find(1);if(c.line==o)return c;d=n.getLine(l,o=c.line)}}function F(e,t,i,n){n-=M(t);let r=t.text.length,l=s.findFirst(t=>w(e,i,t-1).bottom<=n,r,0);return{begin:l,end:r=s.findFirst(t=>w(e,i,t).top>n,l,r)}}function O(e,t,i,n){return!(e.bottom<=i)&&(e.top>i||(n?e.left:e.right)>t)}function E(e,n,l,o,a){a-=i.heightAtLine(n);let d=C(e,n),c=(M(n),0),u=n.text.length,h=!0,g=r.getOrder(n,e.doc.direction);if(g){let i=(e.options.lineWrapping?function(e,t,i,n,r,l,o){let{begin:a,end:d}=F(e,t,n,o);/\s/.test(t.text.charAt(d-1))&&d--;let s=null,c=null;for(let t=0;t<r.length;t++){let i=r[t];if(i.from>=d||i.to<=a)continue;let o=1!=i.level,f=w(e,n,o?Math.min(d,i.to)-1:Math.max(a,i.from)).right,u=f<l?l-f+1e9:f-l;(!s||c>u)&&(s=i,c=u)}s||(s=r[r.length-1]);s.from<a&&(s={from:a,to:s.to,level:s.level});s.to>d&&(s={from:s.from,to:d,level:s.level});return s}:function(e,i,n,r,l,o,a){let d=s.findFirst(d=>{let s=l[d],c=1!=s.level;return O(N(e,t.Pos(n,c?s.to:s.from,c?"before":"after"),"line",i,r),o,a,!0)},0,l.length-1),c=l[d];if(d>0){let s=1!=c.level,f=N(e,t.Pos(n,s?c.from:c.to,s?"after":"before"),"line",i,r);O(f,o,a,!0)&&f.top>a&&(c=l[d-1])}return c})(e,n,l,d,g,o,a);c=(h=1!=i.level)?i.from:i.to-1,u=h?i.to:i.from-1}let p,m,b=null,y=null,x=s.findFirst(t=>{let i=w(e,d,t);return i.top+=f.widgetHeight,i.bottom+=f.widgetHeight,!!O(i,o,a,!1)&&(i.top<=a&&i.left<=o&&(b=t,y=i),!0)},c,u),v=!1;if(y){let e=o-y.left<y.right-o,t=e==h;x=b+(t?0:1),m=t?"after":"before",p=e?y.left:y.right}else{h||x!=u&&x!=c||x++,m=0==x?"after":x==n.text.length?"before":w(e,d,x-(h?1:0)).bottom+f.widgetHeight<=a==h?"after":"before";let i=N(e,t.Pos(l,x,m),"line",n,d);p=i.left,v=a<i.top||a>=i.bottom}return I(l,x=s.skipExtendingChars(n.text,x,1),m,v,o-p)}function D(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==x){x=o.elt("pre");for(let e=0;e<49;++e)x.appendChild(document.createTextNode("x")),x.appendChild(o.elt("br"));x.appendChild(document.createTextNode("x"))}o.removeChildrenAndAdd(e.measure,x);let t=x.offsetHeight/50;return t>3&&(e.cachedTextHeight=t),o.removeChildren(e.measure),t||1}function _(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;let t=o.elt("span","xxxxxxxxxx"),i=o.elt("pre",[t]);o.removeChildrenAndAdd(e.measure,i);let n=t.getBoundingClientRect(),r=(n.right-n.left)/10;return r>2&&(e.cachedCharWidth=r),r||10}function z(e){let t=e.display,i={},n={},r=t.gutters.clientLeft;for(let l=t.gutters.firstChild,o=0;l;l=l.nextSibling,++o)i[e.options.gutters[o]]=l.offsetLeft+l.clientLeft+r,n[e.options.gutters[o]]=l.clientWidth;return{fixedPos:X(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:i,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function X(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function V(e){let t=D(e.display),n=e.options.lineWrapping,r=n&&Math.max(5,e.display.scroller.clientWidth/_(e.display)-3);return l=>{if(i.lineIsHidden(e.doc,l))return 0;let o=0;if(l.widgets)for(let e=0;e<l.widgets.length;e++)l.widgets[e].height&&(o+=l.widgets[e].height);return n?o+(Math.ceil(l.text.length/r)||1)*t:o+t}}function k(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;let i=e.display.view;for(let e=0;e<i.length;e++)if((t-=i[e].size)<0)return e}return{paddingTop:u,paddingVert:function(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight},paddingH:h,scrollGap:g,displayWidth:p,displayHeight:function(e){return e.display.scroller.clientHeight-g(e)-e.display.barHeight},mapFromLineView:m,measureChar:b,findViewForLine:y,prepareMeasureForLine:C,measureCharPrepared:w,nodeAndOffsetInLineMap:L,clearLineMeasurementCacheFor:W,clearLineMeasurementCache:R,clearCaches:function(e){R(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null},intoCoordSystem:B,fromCoordSystem:function(e,t,i){if("div"==i)return t;let n=t.left,r=t.top;if("page"==i)n-=S(),r-=A();else if("local"==i||!i){let t=e.display.sizer.getBoundingClientRect();n+=t.left,r+=t.top}let l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:r-l.top}},charCoords:function(e,t,i,r,l){return r||(r=n.getLine(e.doc,t.line)),B(e,r,b(e,r,t.ch,l),i)},cursorCoords:N,estimateCoords:function(e,r){let l=0;r=t.clipPos(e.doc,r),e.options.lineWrapping||(l=_(e.display)*r.ch);let o=n.getLine(e.doc,r.line),a=i.heightAtLine(o)+u(e.display);return{left:l,right:l,top:a,bottom:a+o.height}},coordsChar:T,wrappedLineExtentChar:function(e,t,i,n){return i||(i=C(e,t)),F(e,t,i,B(e,t,w(e,i,n),"line").top)},textHeight:D,charWidth:_,getDimensions:z,compensateForHScroll:X,estimateHeight:V,estimateLineHeights:function(e){let t=e.doc,i=V(e);t.iter(e=>{let t=i(e);t!=e.height&&n.updateLineHeight(e,t)})},posFromMouse:function(e,i,r,l){let o=e.display;if(!r&&"true"==a.e_target(i).getAttribute("cm-not-content"))return null;let d,c,f=o.lineSpace.getBoundingClientRect();try{d=i.clientX-f.left,c=i.clientY-f.top}catch(i){return null}let u,g=T(e,d,c);if(l&&1==g.xRel&&(u=n.getLine(e.doc,g.line).text).length==g.ch){let i=s.countColumn(u,u.length,e.options.tabSize)-u.length;g=t.Pos(g.line,Math.max(0,Math.round((d-h(e.display).left)/_(e.display))-i))}return g},findViewIndex:k}});
//# sourceMappingURL=../../sourcemaps/lib/measurement/position_measurement.js.map
