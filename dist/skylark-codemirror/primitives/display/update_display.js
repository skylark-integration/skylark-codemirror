/**
 * skylark-codemirror - A version of codemirror 5.45  that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror/
 * @license MIT
 */
define(["../line/saw_special_spans","../line/spans","../line/utils_line","../measurement/position_measurement","../util/browser","../util/dom","../util/event","../util/misc","./update_line","./selection","./update_lines","./view_tracking"],function(e,i,t,s,r,o,n,a,d,p,c,u){"use strict";class h{constructor(e,i,t){let l=e.display;this.viewport=i,this.visible=c.visibleLines(l,e.doc,i),this.editorIsHidden=!l.wrapper.offsetWidth,this.wrapperHeight=l.wrapper.clientHeight,this.wrapperWidth=l.wrapper.clientWidth,this.oldDisplayWidth=s.displayWidth(e),this.force=t,this.dims=s.getDimensions(e),this.events=[]}signal(e,i){n.hasHandler(e,i)&&this.events.push(arguments)}finish(){for(let e=0;e<this.events.length;e++)n.signal.apply(null,this.events[e])}}function f(l,n){let p=l.display,c=l.doc;if(n.editorIsHidden)return u.resetView(l),!1;if(!n.force&&n.visible.from>=p.viewFrom&&n.visible.to<=p.viewTo&&(null==p.updateLineNumbers||p.updateLineNumbers>=p.viewTo)&&p.renderedView==p.view&&0==u.countDirtyView(l))return!1;l.maybeUpdateLineNumberWidth()&&(u.resetView(l),n.dims=s.getDimensions(l));let h=c.first+c.size,f=Math.max(n.visible.from-l.options.viewportMargin,c.first),v=Math.min(h,n.visible.to+l.options.viewportMargin);p.viewFrom<f&&f-p.viewFrom<20&&(f=Math.max(c.first,p.viewFrom)),p.viewTo>v&&p.viewTo-v<20&&(v=Math.min(h,p.viewTo)),e.sawCollapsedSpans&&(f=i.visualLineNo(l.doc,f),v=i.visualLineEndNo(l.doc,v));let w=f!=p.viewFrom||v!=p.viewTo||p.lastWrapHeight!=n.wrapperHeight||p.lastWrapWidth!=n.wrapperWidth;u.adjustView(l,f,v),p.viewOffset=i.heightAtLine(t.getLine(l.doc,p.viewFrom)),l.display.mover.style.top=p.viewOffset+"px";let m=u.countDirtyView(l);if(!w&&0==m&&!n.force&&p.renderedView==p.view&&(null==p.updateLineNumbers||p.updateLineNumbers>=p.viewTo))return!1;let y=function(e){if(e.hasFocus())return null;let i=o.activeElt();if(!i||!o.contains(e.display.lineDiv,i))return null;let t={activeElt:i};if(window.getSelection){let i=window.getSelection();i.anchorNode&&i.extend&&o.contains(e.display.lineDiv,i.anchorNode)&&(t.anchorNode=i.anchorNode,t.anchorOffset=i.anchorOffset,t.focusNode=i.focusNode,t.focusOffset=i.focusOffset)}return t}(l);return m>4&&(p.lineDiv.style.display="none"),function(e,i,s){let l=e.display,n=e.options.lineNumbers,p=l.lineDiv,c=p.firstChild;function u(i){let t=i.nextSibling;return r.webkit&&r.mac&&e.display.currentWheelTarget==i?i.style.display="none":i.parentNode.removeChild(i),t}let h=l.view,f=l.viewFrom;for(let l=0;l<h.length;l++){let r=h[l];if(r.hidden);else if(r.node&&r.node.parentNode==p){for(;c!=r.node;)c=u(c);let l=n&&null!=i&&i<=f&&r.lineNumber;r.changes&&(a.indexOf(r.changes,"gutter")>-1&&(l=!1),d.updateLineForChanges(e,r,f,s)),l&&(o.removeChildren(r.lineNumber),r.lineNumber.appendChild(document.createTextNode(t.lineNumberFor(e.options,f)))),c=r.node.nextSibling}else{let i=d.buildLineElement(e,r,f,s);p.insertBefore(i,c)}f+=r.size}for(;c;)c=u(c)}(l,p.updateLineNumbers,n.dims),m>4&&(p.lineDiv.style.display=""),p.renderedView=p.view,function(e){if(e&&e.activeElt&&e.activeElt!=o.activeElt()&&(e.activeElt.focus(),e.anchorNode&&o.contains(document.body,e.anchorNode)&&o.contains(document.body,e.focusNode))){let i=window.getSelection(),t=document.createRange();t.setEnd(e.anchorNode,e.anchorOffset),t.collapse(!1),i.removeAllRanges(),i.addRange(t),i.extend(e.focusNode,e.focusOffset)}}(y),o.removeChildren(p.cursorDiv),o.removeChildren(p.selectionDiv),p.gutters.style.height=p.sizer.style.minHeight=0,w&&(p.lastWrapHeight=n.wrapperHeight,p.lastWrapWidth=n.wrapperWidth,l.startWorker(400)),p.updateLineNumbers=null,!0}function v(e,i){let t=i.viewport;for(let l=!0;(l&&e.options.lineWrapping&&i.oldDisplayWidth!=s.displayWidth(e)||(t&&null!=t.top&&(t={top:Math.min(e.doc.height+s.paddingVert(e.display)-s.displayHeight(e),t.top)}),i.visible=c.visibleLines(e.display,e.doc,t),!(i.visible.from>=e.display.viewFrom&&i.visible.to<=e.display.viewTo)))&&f(e,i);l=!1){c.updateHeightsInViewport(e);let t=e.measureForScrollbars();p.updateSelection(e),e.updateScrollbars(t),w(e,t),i.force=!1}i.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(i.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function w(e,i){e.display.sizer.style.minHeight=i.docHeight+"px",e.display.heightForcer.style.top=i.docHeight+"px",e.display.gutters.style.height=i.docHeight+e.display.barHeight+s.scrollGap(e)+"px"}return{DisplayUpdate:h,maybeClipScrollbars:function(e){let i=e.display;!i.scrollbarsClipped&&i.scroller.offsetWidth&&(i.nativeBarWidth=i.scroller.offsetWidth-i.scroller.clientWidth,i.heightForcer.style.height=s.scrollGap(e)+"px",i.sizer.style.marginBottom=-i.nativeBarWidth+"px",i.sizer.style.borderRightWidth=s.scrollGap(e)+"px",i.scrollbarsClipped=!0)},updateDisplayIfNeeded:f,postUpdateDisplay:v,updateDisplaySimple:function(e,i){let t=new h(e,i);if(f(e,t)){c.updateHeightsInViewport(e),v(e,t);let i=l.measureForScrollbars(e);p.updateSelection(e),l.updateScrollbars(e,i),w(e,i),t.finish()}},updateGutterSpace:function(e){let i=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=i+"px"},setDocumentHeight:w}});
//# sourceMappingURL=../../sourcemaps/primitives/display/update_display.js.map
