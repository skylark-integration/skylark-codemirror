/**
 * skylark-codemirror - A version of codemirror 5.45  that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror/
 * @license MIT
 */
define(["../display/operations","../display/selection","./input","../measurement/position_measurement","../measurement/widgets","../model/selection","../model/selection_updates","../util/browser","../util/dom","../util/event","../util/feature_detection","../util/misc"],function(e,t,i,n,s,o,l,r,p,a,c,u){"use strict";class d{constructor(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new u.Delayed,this.undefined=!1,this.composing=null}init(e){let t=this,n=this.cm;this.createField(e);const s=this.textarea;function o(e){if(!a.signalDOMEvent(n,e)){if(n.somethingSelected())i.setLastCopied({lineWise:!1,text:n.getSelections()});else{if(!n.options.lineWiseCopyCut)return;{let o=i.copyableRanges(n);i.setLastCopied({lineWise:!0,text:o.text}),"cut"==e.type?n.setSelections(o.ranges,null,u.sel_dontScroll):(t.prevInput="",s.value=o.text.join("\n"),p.selectInput(s))}}"cut"==e.type&&(n.state.cutIncoming=+new Date)}}e.wrapper.insertBefore(this.wrapper,e.wrapper.firstChild),r.ios&&(s.style.width="0px"),a.on(s,"input",()=>{r.ie&&r.ie_version>=9&&this.undefined&&(this.undefined=null),t.poll()}),a.on(s,"paste",e=>{a.signalDOMEvent(n,e)||i.handlePaste(e,n)||(n.state.pasteIncoming=+new Date,t.fastPoll())}),a.on(s,"cut",o),a.on(s,"copy",o),a.on(e.scroller,"paste",i=>{if(i.eventInWidget(e,i)||a.signalDOMEvent(n,i))return;if(!s.dispatchEvent)return n.state.pasteIncoming=+new Date,void t.focus();const o=new Event("paste");o.clipboardData=i.clipboardData,s.dispatchEvent(o)}),a.on(e.lineSpace,"selectstart",t=>{t.eventInWidget(e,t)||a.e_preventDefault(t)}),a.on(s,"compositionstart",()=>{let e=n.getCursor("from");t.composing&&t.composing.range.clear(),t.composing={start:e,range:n.markText(e,n.getCursor("to"),{className:"CodeMirror-composing"})}}),a.on(s,"compositionend",()=>{t.composing&&(t.poll(),t.composing.range.clear(),t.composing=null)})}createField(e){this.wrapper=i.hiddenTextarea(),this.textarea=this.wrapper.firstChild}prepareSelection(){let e=this.cm,i=e.display,s=e.doc,o=t.prepareSelection(e);if(e.options.moveInputWithCursor){let t=n.cursorCoords(e,s.sel.primary().head,"div"),l=i.wrapper.getBoundingClientRect(),r=i.lineDiv.getBoundingClientRect();o.teTop=Math.max(0,Math.min(i.wrapper.clientHeight-10,t.top+r.top-l.top)),o.teLeft=Math.max(0,Math.min(i.wrapper.clientWidth-10,t.left+r.left-l.left))}return o}showSelection(e){let t=this.cm.display;p.removeChildrenAndAdd(t.cursorDiv,e.cursors),p.removeChildrenAndAdd(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")}reset(e){if(this.contextMenuPending||this.composing)return;let t=this.cm;if(t.somethingSelected()){this.prevInput="";let e=t.getSelection();this.textarea.value=e,t.state.focused&&p.selectInput(this.textarea),r.ie&&r.ie_version>=9&&(this.undefined=e)}else e||(this.prevInput=this.textarea.value="",r.ie&&r.ie_version>=9&&(this.undefined=null))}getField(){return this.textarea}supportsTouch(){return!1}focus(){if("nocursor"!=this.cm.options.readOnly&&(!r.mobile||p.activeElt()!=this.textarea))try{this.textarea.focus()}catch(e){}}blur(){this.textarea.blur()}resetPosition(){this.wrapper.style.top=this.wrapper.style.left=0}receivedFocus(){this.slowPoll()}slowPoll(){this.pollingFast||this.polling.set(this.cm.options.pollInterval,()=>{this.poll(),this.cm.state.focused&&this.slowPoll()})}fastPoll(){let e=!1,t=this;t.pollingFast=!0,t.polling.set(20,function i(){t.poll()||e?(t.pollingFast=!1,t.slowPoll()):(e=!0,t.polling.set(60,i))})}poll(){let t=this.cm,n=this.textarea,s=this.prevInput;if(this.contextMenuPending||!t.state.focused||c.hasSelection(n)&&!s&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;let o=n.value;if(o==s&&!t.somethingSelected())return!1;if(r.ie&&r.ie_version>=9&&this.undefined===o||r.mac&&/[\uf700-\uf7ff]/.test(o))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){let e=o.charCodeAt(0);if(8203!=e||s||(s="​"),8666==e)return this.reset(),this.cm.execCommand("undo")}let l=0,p=Math.min(s.length,o.length);for(;l<p&&s.charCodeAt(l)==o.charCodeAt(l);)++l;return e.runInOp(t,()=>{i.applyTextInput(t,o.slice(l),s.length-l,null,this.composing?"*compose":null),o.length>1e3||o.indexOf("\n")>-1?n.value=this.prevInput="":this.prevInput=o,this.composing&&(this.composing.range.clear(),this.composing.range=t.markText(this.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0}ensurePolled(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)}onKeyPress(){r.ie&&r.ie_version>=9&&(this.undefined=null),this.fastPoll()}onContextMenu(t){let i=this,s=i.cm,p=s.display,c=i.textarea;i.contextMenuPending&&i.contextMenuPending();let d=n.posFromMouse(s,t),h=p.scroller.scrollTop;if(!d||r.presto)return;s.options.resetSelectionOnContextMenu&&-1==s.doc.sel.contains(d)&&e.operation(s,l.setSelection)(s.doc,o.simpleSelection(d),u.sel_dontScroll);let g,m=c.style.cssText,f=i.wrapper.style.cssText,x=i.wrapper.offsetParent.getBoundingClientRect();function v(){if(null!=c.selectionStart){let e=s.somethingSelected(),t="​"+(e?c.value:"");c.value="⇚",c.value=t,i.prevInput=e?"":"​",c.selectionStart=1,c.selectionEnd=t.length,p.selForContextMenu=s.doc.sel}}function w(){if(i.contextMenuPending==w&&(i.contextMenuPending=!1,i.wrapper.style.cssText=f,c.style.cssText=m,r.ie&&r.ie_version<9&&p.scrollbars.setScrollTop(p.scroller.scrollTop=h),null!=c.selectionStart)){(!r.ie||r.ie&&r.ie_version<9)&&v();let t=0,n=()=>{p.selForContextMenu==s.doc.sel&&0==c.selectionStart&&c.selectionEnd>0&&"​"==i.prevInput?e.operation(s,l.selectAll)(s):t++<10?p.detectingSelectAll=setTimeout(n,500):(p.selForContextMenu=null,p.input.reset())};p.detectingSelectAll=setTimeout(n,200)}}if(i.wrapper.style.cssText="position: static",c.style.cssText=`position: absolute; width: 30px; height: 30px;\n      top: ${t.clientY-x.top-5}px; left: ${t.clientX-x.left-5}px;\n      z-index: 1000; background: ${r.ie?"rgba(255, 255, 255, .05)":"transparent"};\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`,r.webkit&&(g=window.scrollY),p.input.focus(),r.webkit&&window.scrollTo(null,g),p.input.reset(),s.somethingSelected()||(c.value=i.prevInput=" "),i.contextMenuPending=w,p.selForContextMenu=s.doc.sel,clearTimeout(p.detectingSelectAll),r.ie&&r.ie_version>=9&&v(),r.captureRightClick){a.e_stop(t);let e=()=>{a.off(window,"mouseup",e),setTimeout(w,20)};a.on(window,"mouseup",e)}else setTimeout(w,50)}readOnlyChanged(e){e||this.reset(),this.textarea.disabled="nocursor"==e}setUneditable(){}}return d.prototype.needsContentAttribute=!1,d});
//# sourceMappingURL=../../sourcemaps/primitives/input/TextareaInput.js.map
