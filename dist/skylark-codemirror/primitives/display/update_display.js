/**
 * skylark-codemirror - A version of codemirror 5.45  that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-codemirror/
 * @license MIT
 */
define(["../line/saw_special_spans","../line/spans","../line/utils_line","../measurement/position_measurement","../util/browser","../util/dom","../util/event","../util/misc","./update_line","./highlight_worker","./line_numbers","./scrollbars","./selection","./update_lines","./view_tracking"],function(e,i,t,s,l,r,o,n,a,d,p,c,h,u,f){"use strict";class v{constructor(e,i,t){let l=e.display;this.viewport=i,this.visible=u.visibleLines(l,e.doc,i),this.editorIsHidden=!l.wrapper.offsetWidth,this.wrapperHeight=l.wrapper.clientHeight,this.wrapperWidth=l.wrapper.clientWidth,this.oldDisplayWidth=s.displayWidth(e),this.force=t,this.dims=s.getDimensions(e),this.events=[]}signal(e,i){o.hasHandler(e,i)&&this.events.push(arguments)}finish(){for(let e=0;e<this.events.length;e++)o.signal.apply(null,this.events[e])}}function w(o,a){let c=o.display,h=o.doc;if(a.editorIsHidden)return f.resetView(o),!1;if(!a.force&&a.visible.from>=c.viewFrom&&a.visible.to<=c.viewTo&&(null==c.updateLineNumbers||c.updateLineNumbers>=c.viewTo)&&c.renderedView==c.view&&0==f.countDirtyView(o))return!1;p.maybeUpdateLineNumberWidth(o)&&(f.resetView(o),a.dims=s.getDimensions(o));let u=h.first+h.size,v=Math.max(a.visible.from-o.options.viewportMargin,h.first),w=Math.min(u,a.visible.to+o.options.viewportMargin);c.viewFrom<v&&v-c.viewFrom<20&&(v=Math.max(h.first,c.viewFrom)),c.viewTo>w&&c.viewTo-w<20&&(w=Math.min(u,c.viewTo)),e.sawCollapsedSpans&&(v=i.visualLineNo(o.doc,v),w=i.visualLineEndNo(o.doc,w));let m=v!=c.viewFrom||w!=c.viewTo||c.lastWrapHeight!=a.wrapperHeight||c.lastWrapWidth!=a.wrapperWidth;f.adjustView(o,v,w),c.viewOffset=i.heightAtLine(t.getLine(o.doc,c.viewFrom)),o.display.mover.style.top=c.viewOffset+"px";let y=f.countDirtyView(o);if(!m&&0==y&&!a.force&&c.renderedView==c.view&&(null==c.updateLineNumbers||c.updateLineNumbers>=c.viewTo))return!1;let g=function(e){if(e.hasFocus())return null;let i=r.activeElt();if(!i||!r.contains(e.display.lineDiv,i))return null;let t={activeElt:i};if(window.getSelection){let i=window.getSelection();i.anchorNode&&i.extend&&r.contains(e.display.lineDiv,i.anchorNode)&&(t.anchorNode=i.anchorNode,t.anchorOffset=i.anchorOffset,t.focusNode=i.focusNode,t.focusOffset=i.focusOffset)}return t}(o);return y>4&&(c.lineDiv.style.display="none"),function(e,i,s){let o=e.display,a=e.options.lineNumbers,d=o.lineDiv,p=d.firstChild;function c(i){let t=i.nextSibling;return l.webkit&&l.mac&&e.display.currentWheelTarget==i?i.style.display="none":i.parentNode.removeChild(i),t}let h=o.view,u=o.viewFrom;for(let l=0;l<h.length;l++){let o=h[l];if(o.hidden);else if(o.node&&o.node.parentNode==d){for(;p!=o.node;)p=c(p);let d=a&&null!=i&&i<=u&&o.lineNumber;o.changes&&(n.indexOf(o.changes,"gutter")>-1&&(d=!1),l.updateLineForChanges(e,o,u,s)),d&&(r.removeChildren(o.lineNumber),o.lineNumber.appendChild(document.createTextNode(t.lineNumberFor(e.options,u)))),p=o.node.nextSibling}else{let i=l.buildLineElement(e,o,u,s);d.insertBefore(i,p)}u+=o.size}for(;p;)p=c(p)}(o,c.updateLineNumbers,a.dims),y>4&&(c.lineDiv.style.display=""),c.renderedView=c.view,function(e){if(e&&e.activeElt&&e.activeElt!=r.activeElt()&&(e.activeElt.focus(),e.anchorNode&&r.contains(document.body,e.anchorNode)&&r.contains(document.body,e.focusNode))){let i=window.getSelection(),t=document.createRange();t.setEnd(e.anchorNode,e.anchorOffset),t.collapse(!1),i.removeAllRanges(),i.addRange(t),i.extend(e.focusNode,e.focusOffset)}}(g),r.removeChildren(c.cursorDiv),r.removeChildren(c.selectionDiv),c.gutters.style.height=c.sizer.style.minHeight=0,m&&(c.lastWrapHeight=a.wrapperHeight,c.lastWrapWidth=a.wrapperWidth,d.startWorker(o,400)),c.updateLineNumbers=null,!0}function m(e,i){let t=i.viewport;for(let l=!0;(l&&e.options.lineWrapping&&i.oldDisplayWidth!=s.displayWidth(e)||(t&&null!=t.top&&(t={top:Math.min(e.doc.height+s.paddingVert(e.display)-s.displayHeight(e),t.top)}),i.visible=u.visibleLines(e.display,e.doc,t),!(i.visible.from>=e.display.viewFrom&&i.visible.to<=e.display.viewTo)))&&w(e,i);l=!1){u.updateHeightsInViewport(e);let t=c.measureForScrollbars(e);h.updateSelection(e),c.updateScrollbars(e,t),y(e,t),i.force=!1}i.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(i.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function y(e,i){e.display.sizer.style.minHeight=i.docHeight+"px",e.display.heightForcer.style.top=i.docHeight+"px",e.display.gutters.style.height=i.docHeight+e.display.barHeight+s.scrollGap(e)+"px"}return{DisplayUpdate:v,maybeClipScrollbars:function(e){let i=e.display;!i.scrollbarsClipped&&i.scroller.offsetWidth&&(i.nativeBarWidth=i.scroller.offsetWidth-i.scroller.clientWidth,i.heightForcer.style.height=s.scrollGap(e)+"px",i.sizer.style.marginBottom=-i.nativeBarWidth+"px",i.sizer.style.borderRightWidth=s.scrollGap(e)+"px",i.scrollbarsClipped=!0)},updateDisplayIfNeeded:w,postUpdateDisplay:m,updateDisplaySimple:function(e,i){let t=new v(e,i);if(w(e,t)){u.updateHeightsInViewport(e),m(e,t);let i=c.measureForScrollbars(e);h.updateSelection(e),c.updateScrollbars(e,i),y(e,i),t.finish()}},updateGutterSpace:function(e){let i=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=i+"px"},setDocumentHeight:y}});
//# sourceMappingURL=../../sourcemaps/primitives/display/update_display.js.map
